#include <cctag/CCTagMarkersBank.hpp>
#include <cctag/utils/exceptions.hpp>
#include <cctag/utils/Defines.hpp>

#include <boost/numeric/conversion/bounds.hpp>
#include <boost/throw_exception.hpp>

#include <cmath>
#include <fstream>
#include <vector>

namespace cctag
{

CCTagMarkersBank::CCTagMarkersBank( const std::size_t nCrowns )
{
  _markers.clear();
  if ( nCrowns == 3 )
  {
    for (int i=0; i<32; ++i)
    {
      std::vector<double> line;
      line.reserve(5);
      for (int j=0; j<5; ++j)
      {
        line.push_back(CCTagMarkersBank::idThreeCrowns[i][j]);
      }
      _markers.push_back(line);
    }
    
  }else if ( nCrowns == 4 )
  {
    for (int i=0; i<128; ++i)
    {
      std::vector<double> line;
      line.reserve(7);
      for (int j=0; j<7; ++j)
      {
        line.push_back(CCTagMarkersBank::idFourCrowns[i][j]);
      }
      _markers.push_back(line);
    }
  }
}

CCTagMarkersBank::CCTagMarkersBank( const std::string & file )
{
  read( file );
}

CCTagMarkersBank::~CCTagMarkersBank()
{
}

void CCTagMarkersBank::read( const std::string & file )
{
  std::ifstream input( file.c_str() );
  if ( !input.good() )
  {
    BOOST_THROW_EXCEPTION( exception::Value()
                           << exception::dev() + "Unable to open the bank file: " + file );
  }
  std::string str;
  while ( std::getline( input, str ) )
  {
    std::vector<double> rr;
    cctagLineParse( str.begin(), str.end(), rr);
    if ( rr.size() )
    {
      _markers.push_back( rr );
    }
  }
  input.close();
}

std::size_t CCTagMarkersBank::identify( const std::vector<double> & marker ) const
{
  std::vector< std::vector<double> >::const_iterator itm = _markers.begin();

  std::size_t imin = 0;
  double normMin = boost::numeric::bounds<double>::highest();
  std::size_t i = 0;

  while( itm != _markers.end() )
  {
    std::vector<double>::const_iterator itr1 = marker.begin();
    std::vector<double>::const_iterator itr2 = itm->begin();
    double norm = 0;
    while( itr1 != marker.end() && itr2 != itm->end() )
    {
      norm += ( *itr1 - *itr2 ) * ( *itr1 - *itr2 );
      ++itr1;
      ++itr2;
    }
    ++itm;
    norm = std::sqrt( norm );
    CCTAG_COUT_LILIAN( "Res : " << norm );
    if ( norm < normMin )
    {
      normMin = norm;
      imin = i;
    }
    ++i;
  }

  if ( normMin > 0.6 )
  {
    BOOST_THROW_EXCEPTION( cctag::exception::Bug() << cctag::exception::dev() + "Unable to identify marker" );
  }
  else
  {
    return imin + 1;
  }
}

const double CCTagMarkersBank::idThreeCrowns[32][5] =
    {{2.000000,1.666667,1.428571,1.250000,1.111111},
    {2.222222,1.666667,1.428571,1.250000,1.111111},
    {2.222222,1.818182,1.428571,1.250000,1.111111},
    {2.500000,1.818182,1.428571,1.250000,1.111111},
    {2.222222,1.818182,1.538462,1.250000,1.111111},
    {2.500000,1.818182,1.538462,1.250000,1.111111},
    {2.500000,2.000000,1.538462,1.250000,1.111111},
    {2.857143,2.000000,1.538462,1.250000,1.111111},
    {2.222222,1.818182,1.538462,1.333333,1.111111},
    {2.500000,1.818182,1.538462,1.333333,1.111111},
    {2.500000,2.000000,1.538462,1.333333,1.111111},
    {2.857143,2.000000,1.538462,1.333333,1.111111},
    {2.500000,2.000000,1.666667,1.333333,1.111111},
    {2.857143,2.000000,1.666667,1.333333,1.111111},
    {2.857143,2.222222,1.666667,1.333333,1.111111},
    {3.333333,2.222222,1.666667,1.333333,1.111111},
    {2.222222,1.818182,1.538462,1.333333,1.176471},
    {2.500000,1.818182,1.538462,1.333333,1.176471},
    {2.500000,2.000000,1.538462,1.333333,1.176471},
    {2.857143,2.000000,1.538462,1.333333,1.176471},
    {2.500000,2.000000,1.666667,1.333333,1.176471},
    {2.857143,2.000000,1.666667,1.333333,1.176471},
    {2.857143,2.222222,1.666667,1.333333,1.176471},
    {3.333333,2.222222,1.666667,1.333333,1.176471},
    {2.500000,2.000000,1.666667,1.428571,1.176471},
    {2.857143,2.000000,1.666667,1.428571,1.176471},
    {2.857143,2.222222,1.666667,1.428571,1.176471},
    {3.333333,2.222222,1.666667,1.428571,1.176471},
    {2.857143,2.222222,1.818182,1.428571,1.176471},
    {3.333333,2.222222,1.818182,1.428571,1.176471},
    {3.333333,2.500000,1.818182,1.428571,1.176471},
    {4.000000,2.500000,1.818182,1.428571,1.176471}};

const double CCTagMarkersBank::idFourCrowns[128][7] =
    {2.272727,1.923077,1.666667,1.470588,1.315789,1.190476,1.086957,
    2.500000,1.923077,1.666667,1.470588,1.315789,1.190476,1.086957,
    2.500000,2.083333,1.666667,1.470588,1.315789,1.190476,1.086957,
    2.777778,2.083333,1.666667,1.470588,1.315789,1.190476,1.086957,
    2.500000,2.083333,1.785714,1.470588,1.315789,1.190476,1.086957,
    2.777778,2.083333,1.785714,1.470588,1.315789,1.190476,1.086957,
    2.777778,2.272727,1.785714,1.470588,1.315789,1.190476,1.086957,
    3.125000,2.272727,1.785714,1.470588,1.315789,1.190476,1.086957,
    2.500000,2.083333,1.785714,1.562500,1.315789,1.190476,1.086957,
    2.777778,2.083333,1.785714,1.562500,1.315789,1.190476,1.086957,
    2.777778,2.272727,1.785714,1.562500,1.315789,1.190476,1.086957,
    3.125000,2.272727,1.785714,1.562500,1.315789,1.190476,1.086957,
    2.777778,2.272727,1.923077,1.562500,1.315789,1.190476,1.086957,
    3.125000,2.272727,1.923077,1.562500,1.315789,1.190476,1.086957,
    3.125000,2.500000,1.923077,1.562500,1.315789,1.190476,1.086957,
    3.571429,2.500000,1.923077,1.562500,1.315789,1.190476,1.086957,
    2.500000,2.083333,1.785714,1.562500,1.388889,1.190476,1.086957,
    2.777778,2.083333,1.785714,1.562500,1.388889,1.190476,1.086957,
    2.777778,2.272727,1.785714,1.562500,1.388889,1.190476,1.086957,
    3.125000,2.272727,1.785714,1.562500,1.388889,1.190476,1.086957,
    2.777778,2.272727,1.923077,1.562500,1.388889,1.190476,1.086957,
    3.125000,2.272727,1.923077,1.562500,1.388889,1.190476,1.086957,
    3.125000,2.500000,1.923077,1.562500,1.388889,1.190476,1.086957,
    3.571429,2.500000,1.923077,1.562500,1.388889,1.190476,1.086957,
    2.777778,2.272727,1.923077,1.666667,1.388889,1.190476,1.086957,
    3.125000,2.272727,1.923077,1.666667,1.388889,1.190476,1.086957,
    3.125000,2.500000,1.923077,1.666667,1.388889,1.190476,1.086957,
    3.571429,2.500000,1.923077,1.666667,1.388889,1.190476,1.086957,
    3.125000,2.500000,2.083333,1.666667,1.388889,1.190476,1.086957,
    3.571429,2.500000,2.083333,1.666667,1.388889,1.190476,1.086957,
    3.571429,2.777778,2.083333,1.666667,1.388889,1.190476,1.086957,
    4.166667,2.777778,2.083333,1.666667,1.388889,1.190476,1.086957,
    2.500000,2.083333,1.785714,1.562500,1.388889,1.250000,1.086957,
    2.777778,2.083333,1.785714,1.562500,1.388889,1.250000,1.086957,
    2.777778,2.272727,1.785714,1.562500,1.388889,1.250000,1.086957,
    3.125000,2.272727,1.785714,1.562500,1.388889,1.250000,1.086957,
    2.777778,2.272727,1.923077,1.562500,1.388889,1.250000,1.086957,
    3.125000,2.272727,1.923077,1.562500,1.388889,1.250000,1.086957,
    3.125000,2.500000,1.923077,1.562500,1.388889,1.250000,1.086957,
    3.571429,2.500000,1.923077,1.562500,1.388889,1.250000,1.086957,
    2.777778,2.272727,1.923077,1.666667,1.388889,1.250000,1.086957,
    3.125000,2.272727,1.923077,1.666667,1.388889,1.250000,1.086957,
    3.125000,2.500000,1.923077,1.666667,1.388889,1.250000,1.086957,
    3.571429,2.500000,1.923077,1.666667,1.388889,1.250000,1.086957,
    3.125000,2.500000,2.083333,1.666667,1.388889,1.250000,1.086957,
    3.571429,2.500000,2.083333,1.666667,1.388889,1.250000,1.086957,
    3.571429,2.777778,2.083333,1.666667,1.388889,1.250000,1.086957,
    4.166667,2.777778,2.083333,1.666667,1.388889,1.250000,1.086957,
    2.777778,2.272727,1.923077,1.666667,1.470588,1.250000,1.086957,
    3.125000,2.272727,1.923077,1.666667,1.470588,1.250000,1.086957,
    3.125000,2.500000,1.923077,1.666667,1.470588,1.250000,1.086957,
    3.571429,2.500000,1.923077,1.666667,1.470588,1.250000,1.086957,
    3.125000,2.500000,2.083333,1.666667,1.470588,1.250000,1.086957,
    3.571429,2.500000,2.083333,1.666667,1.470588,1.250000,1.086957,
    3.571429,2.777778,2.083333,1.666667,1.470588,1.250000,1.086957,
    4.166667,2.777778,2.083333,1.666667,1.470588,1.250000,1.086957,
    3.125000,2.500000,2.083333,1.785714,1.470588,1.250000,1.086957,
    3.571429,2.500000,2.083333,1.785714,1.470588,1.250000,1.086957,
    3.571429,2.777778,2.083333,1.785714,1.470588,1.250000,1.086957,
    4.166667,2.777778,2.083333,1.785714,1.470588,1.250000,1.086957,
    3.571429,2.777778,2.272727,1.785714,1.470588,1.250000,1.086957,
    4.166667,2.777778,2.272727,1.785714,1.470588,1.250000,1.086957,
    4.166667,3.125000,2.272727,1.785714,1.470588,1.250000,1.086957,
    5.000000,3.125000,2.272727,1.785714,1.470588,1.250000,1.086957,
    2.500000,2.083333,1.785714,1.562500,1.388889,1.250000,1.136364,
    2.777778,2.083333,1.785714,1.562500,1.388889,1.250000,1.136364,
    2.777778,2.272727,1.785714,1.562500,1.388889,1.250000,1.136364,
    3.125000,2.272727,1.785714,1.562500,1.388889,1.250000,1.136364,
    2.777778,2.272727,1.923077,1.562500,1.388889,1.250000,1.136364,
    3.125000,2.272727,1.923077,1.562500,1.388889,1.250000,1.136364,
    3.125000,2.500000,1.923077,1.562500,1.388889,1.250000,1.136364,
    3.571429,2.500000,1.923077,1.562500,1.388889,1.250000,1.136364,
    2.777778,2.272727,1.923077,1.666667,1.388889,1.250000,1.136364,
    3.125000,2.272727,1.923077,1.666667,1.388889,1.250000,1.136364,
    3.125000,2.500000,1.923077,1.666667,1.388889,1.250000,1.136364,
    3.571429,2.500000,1.923077,1.666667,1.388889,1.250000,1.136364,
    3.125000,2.500000,2.083333,1.666667,1.388889,1.250000,1.136364,
    3.571429,2.500000,2.083333,1.666667,1.388889,1.250000,1.136364,
    3.571429,2.777778,2.083333,1.666667,1.388889,1.250000,1.136364,
    4.166667,2.777778,2.083333,1.666667,1.388889,1.250000,1.136364,
    2.777778,2.272727,1.923077,1.666667,1.470588,1.250000,1.136364,
    3.125000,2.272727,1.923077,1.666667,1.470588,1.250000,1.136364,
    3.125000,2.500000,1.923077,1.666667,1.470588,1.250000,1.136364,
    3.571429,2.500000,1.923077,1.666667,1.470588,1.250000,1.136364,
    3.125000,2.500000,2.083333,1.666667,1.470588,1.250000,1.136364,
    3.571429,2.500000,2.083333,1.666667,1.470588,1.250000,1.136364,
    3.571429,2.777778,2.083333,1.666667,1.470588,1.250000,1.136364,
    4.166667,2.777778,2.083333,1.666667,1.470588,1.250000,1.136364,
    3.125000,2.500000,2.083333,1.785714,1.470588,1.250000,1.136364,
    3.571429,2.500000,2.083333,1.785714,1.470588,1.250000,1.136364,
    3.571429,2.777778,2.083333,1.785714,1.470588,1.250000,1.136364,
    4.166667,2.777778,2.083333,1.785714,1.470588,1.250000,1.136364,
    3.571429,2.777778,2.272727,1.785714,1.470588,1.250000,1.136364,
    4.166667,2.777778,2.272727,1.785714,1.470588,1.250000,1.136364,
    4.166667,3.125000,2.272727,1.785714,1.470588,1.250000,1.136364,
    5.000000,3.125000,2.272727,1.785714,1.470588,1.250000,1.136364,
    2.777778,2.272727,1.923077,1.666667,1.470588,1.315789,1.136364,
    3.125000,2.272727,1.923077,1.666667,1.470588,1.315789,1.136364,
    3.125000,2.500000,1.923077,1.666667,1.470588,1.315789,1.136364,
    3.571429,2.500000,1.923077,1.666667,1.470588,1.315789,1.136364,
    3.125000,2.500000,2.083333,1.666667,1.470588,1.315789,1.136364,
    3.571429,2.500000,2.083333,1.666667,1.470588,1.315789,1.136364,
    3.571429,2.777778,2.083333,1.666667,1.470588,1.315789,1.136364,
    4.166667,2.777778,2.083333,1.666667,1.470588,1.315789,1.136364,
    3.125000,2.500000,2.083333,1.785714,1.470588,1.315789,1.136364,
    3.571429,2.500000,2.083333,1.785714,1.470588,1.315789,1.136364,
    3.571429,2.777778,2.083333,1.785714,1.470588,1.315789,1.136364,
    4.166667,2.777778,2.083333,1.785714,1.470588,1.315789,1.136364,
    3.571429,2.777778,2.272727,1.785714,1.470588,1.315789,1.136364,
    4.166667,2.777778,2.272727,1.785714,1.470588,1.315789,1.136364,
    4.166667,3.125000,2.272727,1.785714,1.470588,1.315789,1.136364,
    5.000000,3.125000,2.272727,1.785714,1.470588,1.315789,1.136364,
    3.125000,2.500000,2.083333,1.785714,1.562500,1.315789,1.136364,
    3.571429,2.500000,2.083333,1.785714,1.562500,1.315789,1.136364,
    3.571429,2.777778,2.083333,1.785714,1.562500,1.315789,1.136364,
    4.166667,2.777778,2.083333,1.785714,1.562500,1.315789,1.136364,
    3.571429,2.777778,2.272727,1.785714,1.562500,1.315789,1.136364,
    4.166667,2.777778,2.272727,1.785714,1.562500,1.315789,1.136364,
    4.166667,3.125000,2.272727,1.785714,1.562500,1.315789,1.136364,
    5.000000,3.125000,2.272727,1.785714,1.562500,1.315789,1.136364,
    3.571429,2.777778,2.272727,1.923077,1.562500,1.315789,1.136364,
    4.166667,2.777778,2.272727,1.923077,1.562500,1.315789,1.136364,
    4.166667,3.125000,2.272727,1.923077,1.562500,1.315789,1.136364,
    5.000000,3.125000,2.272727,1.923077,1.562500,1.315789,1.136364,
    4.166667,3.125000,2.500000,1.923077,1.562500,1.315789,1.136364,
    5.000000,3.125000,2.500000,1.923077,1.562500,1.315789,1.136364,
    5.000000,3.571429,2.500000,1.923077,1.562500,1.315789,1.136364,
    6.250000,3.571429,2.500000,1.923077,1.562500,1.315789,1.136364};

} // namespace cctag
